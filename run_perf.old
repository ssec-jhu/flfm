#!/bin/bash

# export CUDA_VISIBLE_DEVICES=""

rm -f flfm/tests/data/yale/output.tif
rm -f cuda_report.nsys-rep
rm -f cuda_report.sqlite
rm -f pref_report_csv*.csv
rm -f cprof_report.prof


# sudo /usr/local/cuda/bin/ncu -f -o ncu_profile \
# /home/ryan/miniforge3/envs/flfm-pytorch/bin/python -m flfm.cli main \
# flfm/tests/data/yale/light_field_image.tif \
# flfm/tests/data/yale/measured_psf.tif \
# flfm/tests/data/yale/output.tif \
# 230 \
# --num_iters 10 \
# --lens_center "(1000, 980)"


nsys profile \
--output=cuda_report.nsys-rep \
--cuda-memory-usage=true \
--trace=cuda,nvtx,cublas,cublas-verbose,cusolver,cusolver-verbose,cusparse,cusparse-verbose,mpi,oshmem,ucx,nvvideo,osrt,cudnn,opengl,opengl-annotations,openacc,openmp,vulkan,vulkan-annotations,syscall \
--python-sampling=true \
python -m flfm.cli main \
flfm/tests/data/yale/light_field_image.tif \
flfm/tests/data/yale/measured_psf.tif \
flfm/tests/data/yale/output.tif \
230 \
--num_iters 10 \
--lens_center "(1000, 980)"

nsys stats \
--force-export=true \
--format=csv \
--timeunit=seconds \
--output=perf_report.csv \
cuda_report.nsys-rep

@REM python -m cProfile -o cprof_report.prof \
@REM -m flfm.cli main \
@REM flfm/tests/data/yale/light_field_image.tif \
@REM flfm/tests/data/yale/measured_psf.tif \
@REM flfm/tests/data/yale/output.tif \
@REM 230 \
@REM --num_iters 10 \
@REM --lens_center "(1000, 980)"
